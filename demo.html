<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="nouislider.js"></script>
    <script src="wNumb.js"></script>
    <script type="text/javascript" src="depths.json"></script>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <link rel="stylesheet" type="text/css" href="nouislider.css">
	<link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">
    <script src="plotly.js"></script>
    <script src="selectMap.js"></script>
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
    <script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>


    <script src="https://unpkg.com/topojson@3"></script>

<link href="NAKFI.css" rel="stylesheet" type="text/css">
</head>
<body>
    <div class="parent" id="parent">
      <div class="superbar" id="superbar">
        <div class="topbar">
          <h1>mapping the deep</h1></div>
        <div class="sidebar" id="sidebar">
          <h6>TEMPERATURE</h6>
          <div class="slider" id="tempSlider"></div>
          <h6>OXYGEN </h6>
          <div class="slider" id="oxySlider"></div>
          <h6>SALINITY</h6>
          <div class="slider" id="saltSlider"></div>
            <h6>YEAR</h6>

            <div class="slider" id="yearSlider"></div>
			<div >
				<h6 style="margin-top: 30px">Choose Basin</h6>
				<select id="basin-menu" class="menu">
					<option value="0" id="world">World</option>
					<option value="1" id="northPacific">North Pacific</option>
                    <option value="1" id="southPacific">South Pacific</option>
                    <option value="2" id="Atlantic">Atlantic</option>
                    <option value="3" id="Indian">Indian</option>
                    <option value="4" id="Arctic">Arctic</option>
                    <option value="5" id="Mediterranean">Mediterranean Sea</option>
                    <option value="6" id="caspian">Caspian Sea</option>
                    <option value="7" id="blackSea">Black Sea</option>
                    <option value="8" id="redSea">Red Sea</option>
				</select>
			</div>
			<button class="button" onclick="buttonClick()">Get the data</button>
            <button class="button" onclick="buttonPlot()">Show the data</button>
                        <button class="button" onclick="saveDataset(data)">Save Data</button>

            <p id="ready">Data status:</p>
            <p id="size">Data Size:</p>

			  <button class="button" onclick="w3_open(1)">Viewer Options</button>
                        <button class="button" onclick="w3_open(2)">Saved Data</button>

			<div class="w3-sidebar w3-bar-block w3-dark-grey w3-animate-left" style="display:none" id="1">
                <h6>Reset View to Saved Layout</h6>
                <select id='viewsList'></select>
                <button class="button" onclick='resetView()'>Set View</button>
                <h6>Bathymetry Opacity</h6>
                <div class="slider" id="opacitySlider"></div>
                <h6>Depth Range</h6>
                <div class="slider" id="depthSlider"></div>
                <h6>Select Custom Latitude/Longitude Range</h6>
                <div id="rangeMap"></div>
</div>


            <div class="w3-sidebar w3-bar-block w3-dark-grey w3-animate-left" style="display:none" id="2">
            <div><h6>Load Saved Parameters</h6>
                <select id="saveList"></select>
            <button class="button" onclick="loadDataset()">Load Parameters</button>
                </div>
            <div>
                <h6>Compare Datasets (select data and year)</h6>
                
                <select id="speciesList1"></select>
                <input id = 'speciesOneYear' type="number" name="year" min="1861" max="2100" defaultValue="1861">
                <select id="speciesList2"></select>
                <input id = 'speciesTwoYear' type="number" name="year" min="1861" max="2100" defaultValue = "1861">

                <button class="button" onclick="overlapPlot()">Calculate Overlap</button>

                
                </div>
</div>
          </div>
      </div> 
    </div>
<p id='demo'></p>
<script>
var data, savedData = {name:[], data:[], params:[]}, views = {name:[],view:[]}, dataUnfiltered, data1 = {}, depthData = {long:[], lat:[], depth:[]}, depthDataArray, speciesOneYear = 1861, speciesTwoYear = 1861;  
var tempSlider = document.getElementById('tempSlider'), oxySlider = document.getElementById('oxySlider'), saltSlider = document.getElementById('saltSlider'), yearSlider = document.getElementById('yearSlider'), opacitySlider = document.getElementById('opacitySlider'), depthSlider = document.getElementById('depthSlider'), allSliderValues;
var filterData = [], isOpen =false, firstPlot=false;
    var speciesOne, speciesTwo, overlap = {depth:[], lon:[], lat:[], year:[]};
var checkboxSalt = document.getElementById('checkboxSalt'),
    checkboxTemp = document.getElementById('checkboxTemp'),
    checkboxOxy = document.getElementById('checkboxOxy');
var saveList = document.getElementById("saveList"), speciesList1 = document.getElementById("speciesList1"), speciesList2 = document.getElementById("speciesList2"), viewsList = document.getElementById('viewsList'), camLayout;
/*d3.csv("https://cors-anywhere.herokuapp.com/http://temp.justinebert.com/depths.csv", function(rows) {
    depthData.push(rows);
    });*/
    getBath();
if(Cookies.get('savedData')){
savedData = JSON.parse(Cookies.get('savedData'))}
if(Cookies.get('views')){
views = JSON.parse(Cookies.get('views'))}
dataList(savedData,saveList)
dataList(savedData,speciesList1)
dataList(savedData,speciesList2)
dataList(views, viewsList)
function w3_open(id) {
    var i = 0;
    if(!isOpen && i==0){
        document.getElementById(id).style.display = "block";
        isOpen = true;
        i++;
    }
    if(isOpen && i==0){
        document.getElementById(id).style.display = "none";
        isOpen = false;
        i++;
    }
}

noUiSlider.create(tempSlider, {
    start: [20, 25],
    connect: true,
        tooltips: [wNumb({decimals: 0}),wNumb({decimals: 0})],

    range: {
        'min': -5,
        'max': 35,
    },
    step: 1,
	pips: {
		mode:'positions',
		values: [0, 25, 50, 75, 100],
		density: 4
	}
});
          var tempSnapValues = [
    document.getElementById('temp-slider-value-lower'),
    document.getElementById('temp-slider-value-upper')
];


//Oxygen Slider
noUiSlider.create(oxySlider, {
    start: [200, 220],
    connect: true,
        tooltips: [wNumb({decimals: 0}),wNumb({decimals: 0})],
    step:1,
    range: {
        'min': 0,
        'max': 400,
    },
	pips: {
		mode:'positions',
		values: [0, 25, 50, 75, 100],
		density: 4
	}	
});
          var oxySnapValues = [
    document.getElementById('oxy-slider-value-lower'),
    document.getElementById('oxy-slider-value-upper')
];


//Salt Slider
noUiSlider.create(saltSlider, {
    start: [33, 35],
    tooltips: [wNumb({decimals: 0}),wNumb({decimals: 0})],
    connect: true,
    range: {
        'min': 0,
        'max': 50,
    },
    step: 1,
	pips: {
		mode:'positions',
		values: [0, 25, 50, 75, 100],
		density: 4
	}
});
          var saltSnapValues = [
    document.getElementById('salt-slider-value-lower'),
    document.getElementById('salt-slider-value-upper')
];

/*saltSlider.noUiSlider.on('update', function (values, handle) {
    saltSnapValues[handle].innerHTML = 'Salinity: ' + values[handle] + '';
});*/
    noUiSlider.create(yearSlider, {
    start: [26],
    tooltips: wNumb({decimals: 0}),
    connect: true,
    step: 1,
    range: {
        'min': 1861,
        'max': 2100,
    },
	pips: {
		mode:'positions',
		values: [0, 25, 50, 75, 100],
		density: 4
	}
});
       noUiSlider.create(opacitySlider, {
    start: [50],
    tooltips: wNumb({decimals: 0}),
    connect: true,
    step: 1,
    range: {
        'min': 0,
        'max': 100,
    },
	pips: {
		mode:'positions',
		values: [0, 25, 50, 75, 100],
		density: 4
	}
});
    noUiSlider.create(depthSlider, {
    start: [0, 3000],
    connect: true,
        tooltips: [wNumb({decimals: 0}),wNumb({decimals: 0})],

    range: {
        'min': 0,
        'max': 5000,
    },
    step: 10,
	pips: {
		mode:'positions',
		values: [0, 25, 50, 75, 100],
		density: 4
	}
});
          var tempSnapValues = [
    document.getElementById('temp-slider-value-lower'),
    document.getElementById('temp-slider-value-upper')
];
          function getBath() {
               d3.csv("https://cors-anywhere.herokuapp.com/http://temp.justinebert.com/bathymetry_60min.csv", function(d){
                      depthData.lat.push(d.lat)
                      depthData.long.push(parseFloat(d.long) + 180)
                      depthData.depth.push(d.ocean_depth)
                  
              })
              /*const Http = new XMLHttpRequest();
                    const url='https://cors-anywhere.herokuapp.com/http://temp.justinebert.com/depths.json'
                    Http.open("GET", url);
                    Http.send();
                    Http.onreadystatechange=(e)=>{
                        if(Http.readyState == 2 ){
                          document.getElementById('ready').innerHTML = 'Data status: downloading';  
                        }
                        if (Http.readyState == 4 && Http.status == 200){
                        document.getElementById('ready').innerHTML = 'Data status: ready';
                        console.log(url);
                        depthDataArray = JSON.parse(Http.responseText);
                        
                        for(i in depthDataArray){
                            depthData.long[i] = depthDataArray[i].long-180;
                            if(depthData.long[i]<-180){
                                depthData.long[i] = depthDataArray[i].long + 180;
                            }
                            depthData.lat[i] = depthDataArray[i].lat;
                            depthData.depth[i] = depthDataArray[i].depth;

                            
                        }*/
          };//{{;
          function buttonClick() {
              var basinMenu = document.getElementById("basin-menu");
              var basinValue = basinMenu.options[basinMenu.selectedIndex].value;
              console.log(basinValue);
              document.getElementById('ready').innerHTML = 'Data status: '; 
              var tempValues = tempSlider.noUiSlider.get(), oxyValues = oxySlider.noUiSlider.get(), saltValues = saltSlider.noUiSlider.get(), selectYear = yearSlider.noUiSlider.get();
              allSliderValues = {
                    'temp':tempValues,
                    'salt':saltValues,
                    'oxy' :oxyValues
              }
                const Http = new XMLHttpRequest();
                    const url='https://cors-anywhere.herokuapp.com/http://jetsam.ocean.washington.edu/NAKFI5?min_temp=' + tempValues[0] + '&max_temp=' + tempValues[1] + '&min_salt=' + saltValues[0] + '&max_salt=' + saltValues[1] + '&min_o2=' + oxyValues[0] + '&max_o2=' + oxyValues[1] + '&min_year=' + selectYear + '&max_year=' + selectYear + '&basin='+ basinValue;
                    Http.open("GET", url);
                    Http.send();
                    Http.onreadystatechange=(e)=>{
                        if(Http.readyState == 2 ){
                          document.getElementById('ready').innerHTML = 'Data status: downloading';  
                        }
                        if (Http.readyState == 4 && Http.status == 200){
                        document.getElementById('ready').innerHTML = 'Data status: ready';
                        console.log(url);
                        data = JSON.parse(Http.responseText);
                        dataUnfiltered = JSON.parse(Http.responseText);
                        for(i in data.depth) {
                            data.depth[i] = -(data.depth[i]);
                                
                            data.lon[i] = data.lon[i] + 180
                            if(data.lon[i]>360){
                                data.lon[i] -= 360
                            }
                            
}
                            for(i in dataUnfiltered.depth) {
                            dataUnfiltered.depth[i] = -(dataUnfiltered.depth[i]);
                            dataUnfiltered.lon[i] = dataUnfiltered.lon[i];
}
                        
                        console.log(data);
                        document.getElementById("size").innerHTML = 'Data Size: ' + data.num + " points";
                        }
                    }
          };
    function setSpeciesOne(){
        var saveSelect = speciesList1.options[speciesList1.selectedIndex].value;
        speciesOneYear = document.getElementById("speciesOneYear").value
        speciesOneParams = JSON.parse(JSON.stringify(savedData.params[saveSelect]));
        speciesOneUrl = 'https://cors-anywhere.herokuapp.com/http://jetsam.ocean.washington.edu/NAKFI5?min_temp=' + speciesOneParams.temp[0] + '&max_temp=' + speciesOneParams.temp[1] + '&min_salt=' + speciesOneParams.salt[0] + '&max_salt=' + speciesOneParams.salt[1] + '&min_o2=' + speciesOneParams.oxy[0] + '&max_o2=' + speciesOneParams.oxy[1] + '&min_year=' + speciesOneYear + '&max_year=' + speciesOneYear;
        const Http = new XMLHttpRequest();
        Http.open("GET", speciesOneUrl);
                    Http.send();
        console.log("one")
                    Http.onreadystatechange=(e)=>{
                        if(Http.readyState == 2 ){
                          document.getElementById('ready').innerHTML = 'Data status: downloading';  
                        }
                        if (Http.readyState == 4 && Http.status == 200){
                        document.getElementById('ready').innerHTML = 'Data status: ready';
                        speciesOne = JSON.parse(Http.responseText);
                        for(i in speciesOne.depth) {
                            speciesOne.depth[i] = -(speciesOne.depth[i]);
                            speciesOne.lon[i] = speciesOne.lon[i];
}                     
                        console.log(speciesOne);
                        }
                    }
        console.log(speciesOne);
    }
    function setSpeciesTwo(callback){
        var saveSelect = speciesList2.options[speciesList2.selectedIndex].value;

        speciesTwoYear = document.getElementById("speciesTwoYear").value
        speciesTwoParams = JSON.parse(JSON.stringify(savedData.params[saveSelect]));
        speciesTwoUrl = 'https://cors-anywhere.herokuapp.com/http://jetsam.ocean.washington.edu/NAKFI5?min_temp=' + speciesTwoParams.temp[0] + '&max_temp=' + speciesTwoParams.temp[1] + '&min_salt=' + speciesTwoParams.salt[0] + '&max_salt=' + speciesTwoParams.salt[1] + '&min_o2=' + speciesTwoParams.oxy[0] + '&max_o2=' + speciesTwoParams.oxy[1] + '&min_year=' + speciesTwoYear + '&max_year=' + speciesTwoYear;
        const Http = new XMLHttpRequest();
        Http.open("GET", speciesTwoUrl);
                    Http.send();
        console.log("two")
                    Http.onreadystatechange=(e)=>{
                        if(Http.readyState == 2 ){
                          document.getElementById('ready').innerHTML = 'Data status: downloading';  
                        }
                        if (Http.readyState == 4 && Http.status == 200){
                        document.getElementById('ready').innerHTML = 'Data status: ready';
                        speciesTwo = JSON.parse(Http.responseText);
                        for(i in speciesTwo.depth) {
                            speciesTwo.depth[i] = -(speciesTwo.depth[i]);
                            speciesTwo.lon[i] = speciesTwo.lon[i];
}
                        console.log(speciesTwo);
                        callback.call()

                        }
                    }
        console.log(speciesTwo);
    }
    function compareSpecies(){
            overlap = {depth:[], lon:[], lat:[], year:[]}
            for(i = 0; i<speciesOne.depth.length; i++){
            for(j = 0; j<speciesTwo.depth.length; j++){
                if( (speciesOne.depth[i]==speciesTwo.depth[j]) && (speciesOne.lon[i]==speciesTwo.lon[j]) && (speciesOne.lat[i]==speciesTwo.lat[j])){
                    overlap.depth[i] = speciesOne.depth[i];
                    overlap.lon[i] = speciesOne.lon[i];
                    overlap.lat[i] = speciesOne.lat[i];
                    overlap.year[i] = speciesOne.year[i];
                    }
                    
                }
            }
        makePlotly(overlap.lat, overlap.lon, overlap.depth, overlap.year, depthData.long, depthData.lat, depthData.depth);
        } 
    

          function makePlotly( lat, long, depth, year, longDepth, latDepth, oceanDepth){
              var basinMenu = document.getElementById("basin-menu");
              var basinValue = basinMenu.options[basinMenu.selectedIndex].value;
              var basinId = basinMenu.options[basinMenu.selectedIndex].id;
              var opacDepth = true, depthOpac = depth.map(function(x){ return -x/1000;});
              console.log(depthOpac);

              var opacityValue = (opacitySlider.noUiSlider.get())/100;
              console.log(opacityValue, lat);
              
              if(basinValue=="0"){
                  var bound1 = 0, bound2 = 359.5, bound3 = -89, bound4 = 89;
                  xSize = 4
              }
              if(basinId == "northPacific"){
                  var bound1 = 90, bound2 = 294, bound3 = -10, bound4 = 67;
                  xSize = 2
              }
              if(basinId == "southPacific"){
                  var bound1 = 90, bound2 = 294, bound3 = -90, bound4 = 10;
                  xSize = 2
              }
              if(basinId == 'Atlantic'){
                  var bound1 = 80, bound2 = 200, bound3 = -80, bound4 = 80;
                  xSize = 2
              }
              var plotDiv = document.getElementById("plot");

                var layout = {
                    autosize:true,
              scene:{
                 aspectmode: "manual",
               aspectratio: {
                 x: xSize, y: 2, z: 1,
                },
               xaxis: {
                nticks: 9,
                range: [bound1, bound2],
                title:'Longitude',
              },
               yaxis: {
                nticks: 7,
                range: [bound3, bound4],
                title: 'Latitude',
              },
               zaxis: {
               nticks: 3,
               range: [-6000, 1],
               title: 'Depth',
              },
                    camera:{
                        eye:{
                            x:0,
                            y:-3,
                            z:4
                        }
                    }
            }};
            var dataset = [{
                type: 'scatter3d',
                mode: 'markers',
                x: long, y: lat, z:depth,
                opacity:1,
                group: depthOpac,
                marker: {
                    opacity:1,
                    size:3,
                    cmin: -1000,
                    cmax: 0,
                    colorscale: [
    ['0.0', 'rgb(165,0,38)'],
    ['0.111111111111', 'rgb(215,48,39)'],
    ['0.222222222222', 'rgb(244,109,67)'],
    ['0.333333333333', 'rgb(253,174,97)'],
    ['0.444444444444', 'rgb(254,224,144)'],
    ['0.555555555556', 'rgb(224,243,248)'],
    ['0.666666666667', 'rgb(171,217,233)'],
    ['0.777777777778', 'rgb(116,173,209)'],
    ['0.888888888889', 'rgb(116,173,209)'],
    ['1.0', 'rgb(69,117,180)']
  ],
                    color: depth
               },
                hovertext: year
                
               },
                           {
                opacity: opacityValue,
                type: 'mesh3d',
                x:longDepth, y:latDepth, z:oceanDepth,
                showscale:false,
                cmin:-6000,
                cmax:100,
                hoverinfo: "none",
                color: oceanDepth,
                intensity:oceanDepth,
                colorscale: [
                    ['0', 'rgb(10,10,140)'],
                    ['.96', 'rgb(100,180,240)'],
                    ['.97', 'rgb(210,180,140)'],
                    ['1', 'rgb(210,180,140)']
                    ],
                }
              ];
  Plotly.newPlot('myDiv', dataset, layout, 
                 {modeBarButtonsToAdd: [{
    name: 'save camera layout',
    click: function(gd) {
        let name = prompt('Enter a name for your camera layout')
      camLayout = gd.layout.scene.camera
        camLayoutUpdate = {
            'scene.camera.up.x':camLayout.up.x,
            'scene.camera.up.y':camLayout.up.y,
            'scene.camera.up.z':camLayout.up.z,
            'scene.camera.eye.x':camLayout.eye.x,
            'scene.camera.eye.y':camLayout.eye.y,
            'scene.camera.eye.z':camLayout.eye.z,
            'scene.camera.center.x':camLayout.center.x,
            'scene.camera.center.y':camLayout.center.y,
            'scene.camera.center.z':camLayout.center.z,
            'scene.camera.projection':camLayout.projection
        }
        views.view.push(camLayoutUpdate)
        views.name.push(name)
        dataList(views, viewsList)
        Cookies.set('views', views)
        
    }}
                                       ]});
};
function timeForward(){
    
}
    function updatePlot(){
        
    }
function toggle(element) {

    // If the checkbox is checked, disabled the slider.
    // Otherwise, re-enable it.
    if (this.checked) {
        element.setAttribute('disabled', true);
    } else {
        element.removeAttribute('disabled');
    }
}
function filterByDepth(){
    var depthRange = depthSlider.noUiSlider.get();
    data1 = JSON.parse(JSON.stringify(data));
    console.log(dataUnfiltered);
    console.log(data1);
    for(var i = 1; i<data1.depth.length; i++){
        if(data1.depth[i] > -depthRange[0] || data1.depth[i] < -depthRange[1]){
            data1.depth.splice(i, 1);
            data1.lat.splice(i, 1);
            data1.lon.splice(i, 1);
            data1.o2.splice(i, 1);
            data1.salt.splice(i, 1);
            data1.temp.splice(i, 1);
            data1.year.splice(i, 1);
            i--;
        }
    }
    console.log(data1, dataUnfiltered);
}
function dataList(listItems, list){
    let options = []
    for(i in listItems.name){
        var opt = listItems.name[i]
        var el = document.createElement("option")
        el.textContent = opt
        el.value = i;
        list.add(el)
    }
    
}
function saveDataset(dataset){
    var name = prompt("Please enter a name for this data");
    savedData.name.push(name);
    let tempValues = tempSlider.noUiSlider.get(), oxyValues = oxySlider.noUiSlider.get(), saltValues = saltSlider.noUiSlider.get(), selectYear = yearSlider.noUiSlider.get();
              allSliderValues = {
                    'temp':tempValues,
                    'salt':saltValues,
                    'oxy' :oxyValues
              }
    savedData.params.push(allSliderValues)
    Cookies.set('savedData',savedData)
    var opt = savedData.name[savedData.name.length-1];
    var el = document.createElement("option");
    el.textContent = opt;
    el.value = savedData.name.length - 1;
    var el1 = document.createElement("option");
    el1.textContent = opt;
    el1.value = savedData.name.length - 1;
    var el2 = document.createElement("option");
    el2.textContent = opt;
    el2.value = savedData.name.length - 1;
    saveList.add(el);
    speciesList1.add(el1);
    speciesList2.add(el2);
}
function loadDataset(){
    var saveSelect = saveList.options[saveList.selectedIndex].value;
    let params = JSON.parse(JSON.stringify(savedData.params[saveSelect]))
    console.log(params)
    saltSlider.noUiSlider.set(params.salt)
    tempSlider.noUiSlider.set(params.temp)
    oxySlider.noUiSlider.set(params.oxy)

}
function resetView(){
    var viewSelect = viewsList.options[viewsList.selectedIndex].value
    Plotly.relayout(myDiv, views.view[viewSelect])
}
function buttonPlot(){
    filterByDepth();
    let data = data1;
    makePlotly(data.lat, data.lon, data.depth, data.year, depthData.long, depthData.lat, depthData.depth);
        console.log(data)
          }
function overlapPlot(){
        setSpeciesOne();
        setSpeciesTwo(compareSpecies);
    //
        console.log(overlap)
          }
var rangeMap = new selectMap("rangeMap");

  </script>
<div id="myDiv">

</div
    </div>

 
 
</body>
</html>